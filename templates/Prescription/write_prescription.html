{% if role == 'doctor' %}
    {% extends 'Doctor/base.html' %}
{% elif role == 'nurse' %}
    {% extends 'Nurse/base.html' %}
{% endif %}

{% block title %}Write Prescription{% endblock %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <link rel="icon" href="/static/uploads/MediHubq.png" type="image/x-icon" sizes="512x512">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

<style>
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --background-color: #f4f6f7;
        --text-color: #333;
        --border-radius: 12px;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--background-color);
        line-height: 1.6;
        color: var(--text-color);
    }

    .container {
        width: 100%;
        max-width: 1200px;
        margin: 2rem auto;
        padding: 1rem;
    }

    .form-box {
        background-color: white;
        border-radius: var(--border-radius);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        padding: 3rem;
        transition: all 0.3s ease;
    }

    .form-box:hover {
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
    }

    .medication-entry {
        background-color: #f9f9f9;
        border-radius: var(--border-radius);
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid #e0e0e0;
        position: relative;
    }

    select, input, textarea {
        width: 100%;
        padding: 0.90rem;
        margin-bottom: 1rem;
        border: 2px solid #e0e0e0;
        border-radius: var(--border-radius);
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    select:focus, 
    input:focus, 
    textarea:focus {
        border-color: var(--secondary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .action-btn {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        background-color: var(--secondary-color);
        color: white;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
        text-align: center;
    }

    .action-btn:hover {
        background-color: #2980b9;
        transform: translateY(-2px);
    }

    .remove-btn {
        top: 10px;
        right: 10px;
        background-color: #e74c3c;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .remove-btn:hover {
        background-color: #c0392b;
    }

    #add-medication-btn {
        top: 10px;
        right: 10px;
        background-color: #2ecc71;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    #add-medication-btn:hover {
        background-color: #27ae60;
    }

    @media screen and (max-width: 600px) {
        .container {
            padding: 0.5rem;
        }

        .form-box {
            padding: 1rem;
        }
    }
</style>

</head>

<div class="container">
    
    <div class="form-box"> 
        <form action="{{ url_for('write_prescription') }}" method="post">
            <center>
                <select name="patient_id" id="patient_id" class="select2" required>
                    <option value="" disabled selected>Select Patient</option>
                    {% for patient in patients %}
                        <option value="{{ patient.id }}">{{ patient.username }}</option>
                    {% endfor %}
                </select>
            </center><br>
        
            <div id="prescription-table-container">
                <!-- Prescription table structure -->
                <table id="prescription-table" class="prescription-table">
                    
                    <tbody>
                        <!-- First medication entry -->
                        <tr class="medication-entry">
                            <td style="padding-right: 10px;">
                                <select name="medication_id[]" class="medication_id select2" required style="width: 300px;">
                                    <option value="" disabled selected>Select Medication</option>
                                    {% for medication in medications %}
                                        <option value="{{ medication.id }}">{{ medication.name }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td style="padding-right: 10px;">
                                <input type="text" name="dosage[]" class="dosage" placeholder="Dosage" required style="width: 300px;">
                            </td>
                            
                            <td style="padding-right: 10px;">
                                <textarea name="instructions[]" class="instructions" rows="2" placeholder="Instructions" required style="width: 300px;"></textarea>
                            </td>

                            <td style="padding-right: 10px;">
                                <button type="button" class="remove-btn" onclick="removeMedication(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        
            <center>
                <button type="button" id="add-medication-btn" onclick="addMedication()">
                    <i class="fas fa-plus-circle" title="Add Item" style="font-size: 24px; cursor: pointer;"></i>
                </button>
            </center><br>
        
            <center>
                <input type="submit" value="Confirm" class="action-btn" onClick="return confirm('Are you sure to create this prescription?')">
            </center>
        </form>
    </div> 
</div>

<script>
    // Add a new medication row
    function addMedication() {
        var table = document.getElementById('prescription-table').getElementsByTagName('tbody')[0];
        var newRow = table.insertRow(table.rows.length);
        
        var medicationCell = newRow.insertCell(0);
        var dosageCell = newRow.insertCell(1);
        var instructionsCell = newRow.insertCell(2);
        var actionCell = newRow.insertCell(3);
        
        medicationCell.innerHTML = `
            <select name="medication_id[]" class="medication_id select2" style="padding-right: 10px;" required>
                <option value="" disabled selected>Select Medication</option>
                {% for medication in medications %}
                    <option value="{{ medication.id }}">{{ medication.name }}</option>
                {% endfor %}
            </select>
        `;
        dosageCell.innerHTML = `<input type="text" name="dosage[]" class="dosage" style="padding-right: 10px;" placeholder="Dosage" required>`;
        instructionsCell.innerHTML = `<textarea name="instructions[]" class="instructions" rows="2" style="padding-right: 10px;" placeholder="Instructions" required></textarea>`;
        actionCell.innerHTML = `<button type="button" class="remove-btn" onclick="removeMedication(this)"><i class="fas fa-trash"></i></button>`;
    }

    // Remove a medication row
    function removeMedication(button) {
        var row = button.closest('tr');
        row.remove();
    }
</script>

<script type="text/javascript">
    $(document).ready(function() {
        // Initialize Select2 for both dropdowns
        $('#patient_id').select2();
        $('.medication_id').select2();
    });
</script>

<br><br>
{% endblock %}

